<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Календарь услуг</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script> 
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f2f2f7;
      color: #333;
    }
    header {
      background: #007aff;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      padding: 16px;
    }
    .calendar {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }
    .day, .month {
      background: white;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    .form-group {
      margin-bottom: 12px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #007aff;
      color: white;
      border: none;
      font-weight: bold;
    }
    .stats {
      margin-top: 20px;
      background: white;
      padding: 16px;
      border-radius: 8px;
    }
    .entry-list {
      margin-top: 20px;
    }
    .entry {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Месяца */
    .month {
      width: calc(33.33%); /* 3 колонки */
      margin-bottom: 16px;
    }
    .calendar {
      grid-template-columns: repeat(3, 1fr); /* 3 колонки */
    }

    /* Месяц с записями */
    .month.has-entries {
      background-color: #d4edda !important;
      color: #155724;
    }

    /* Стрелки меньше */
    #backBtn, #nextBtn {
      font-size: 16px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <header>Календарь услуг</header>
  <main>
    <div style="display:flex;justify-content:space-between;margin-bottom:16px;">
      <button id="backBtn">⬅️</button>
      <div id="monthTitle" style="font-size: 18px; font-weight: bold;"></div>
      <button id="nextBtn">➡️</button>
    </div>

    <div class="calendar" id="calendar"></div>

    <!-- Форма добавления -->
    <div id="addForm" style="display:none;">
      <h3>Добавить запись</h3>
      <div class="form-group">
        <label>Дата</label>
        <input type="text" id="selectedDate" readonly />
      </div>
      <div class="form-group">
        <label>Время</label>
        <input type="time" id="time" />
      </div>
      <div class="form-group">
        <label>Услуга</label>
        <select id="service">
          <option value="Макияж">Макияж</option>
          <option value="Мастер-класс">Мастер-класс</option>
          <option value="Полный образ">Полный образ</option>
        </select>
      </div>
      <div class="form-group">
        <label>Доход (₽)</label>
        <input type="number" id="income" placeholder="Например: 3000" />
      </div>
      <div class="form-group">
        <label>Расходы (материалы, ₽)</label>
        <input type="number" id="expenses" placeholder="Например: 500" />
      </div>
      <button onclick="saveEntry()">Сохранить</button>
    </div>

    <!-- Статистика -->
    <div class="stats" id="stats"></div>
  </main>

  <script>
    console.log("Проверка localStorage:", JSON.parse(localStorage.getItem(`calendarEntries_${userId}`) || "[]"));
    const tg = window.Telegram.WebApp;
    tg.ready();

    const calendarEl = document.getElementById('calendar');
    const statsEl = document.getElementById('stats');
    const monthTitle = document.getElementById('monthTitle');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const addForm = document.getElementById('addForm');

    let currentView = 'year'; // year | months-grid | day
    let currentYear = new Date().getFullYear();
    let currentMonthOffset = 0;
    let selectedMonth = new Date().getMonth(); // 0-11
    let selectedDate = '';
    const user = tg.initDataUnsafe?.user;
    const userId = user ? user.id : 'unknown';

    let serverData = [];

    // Получаем данные с бота
    function fetchServerData(callback) {
      tg.sendData(JSON.stringify({ action: "sync", user_id: userId }));
      callback && setTimeout(callback, 500); // имитация асинхронного ответа
    }

    // Обновляем статистику по пользователю
    function updateGlobalStats() {
      const totalIncome = serverData.reduce((sum, e) => sum + (e.income - e.expenses), 0);

      statsEl.innerHTML = `
        <h4>Статистика за всё время</h4>
        <p>Общий доход: ${totalIncome.toFixed(2)} ₽</p>
      `;
    }

    // Показываем годы
    function showYears() {
      currentView = 'year';
      monthTitle.textContent = currentYear;

      calendarEl.innerHTML = '';

      for (let i = currentYear - 10; i <= currentYear + 10; i++) {
        const div = document.createElement('div');
        div.className = 'day';
        div.innerText = i;
        div.onclick = () => {
          currentYear = i;
          showMonthsGrid(i);
        };
        calendarEl.appendChild(div);
      }

      updateGlobalStats();
    }

    // Показываем месяцы
    function showMonthsGrid(year) {
      currentView = 'months-grid';
      monthTitle.textContent = year;

      calendarEl.innerHTML = '';

      const monthNames = ["Янв", "Фев", "Мар", "Апр", "Май", "Июн",
                          "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"];

      const incomeByMonth = {};
      serverData.filter(e => e.date.startsWith(year)).forEach(e => {
        const m = e.date.split('-')[1];
        if (!incomeByMonth[m]) incomeByMonth[m] = true;
      });

      for (let i = 0; i < 12; i++) {
        const dateStr = `${year}-${String(i + 1).padStart(2, '0')}`;
        const hasEntry = incomeByMonth[String(i + 1).padStart(2, '0')];

        const div = document.createElement('div');
        div.className = 'month';
        if (hasEntry) div.classList.add('has-entries');
        div.innerText = monthNames[i];
        div.onclick = () => {
          selectedMonth = i;
          currentMonthOffset = (year - new Date().getFullYear()) * 12 + i - new Date().getMonth();
          loadCalendar(currentMonthOffset);
        };
        calendarEl.appendChild(div);
      }

      // Статистика за год
      const yearEntries = serverData.filter(e => e.date.startsWith(year));
      const totalIncome = yearEntries.reduce((sum, e) => sum + (e.income - e.expenses), 0);
      statsEl.innerHTML = `
        <h4>Статистика за ${year}</h4>
        <p>Доход за год: ${totalIncome.toFixed(2)} ₽</p>
      `;
    }

    // Календарь с днями
    function loadCalendar(monthOffset = 0) {
      currentView = 'day';
      const now = new Date();
      now.setMonth(now.getMonth() + monthOffset);
      const year = now.getFullYear();
      const month = now.getMonth();
      const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
                          "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
      monthTitle.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay() || 7;

      const entries = serverData.filter(e => e.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`);
      const totalIncome = entries.reduce((sum, e) => sum + (e.income - e.expenses), 0);

      statsEl.innerHTML = `
        <h4>Статистика за месяц</h4>
        <p>Доход за месяц: ${totalIncome.toFixed(2)} ₽</p>
      `;

      calendarEl.innerHTML = '';

      for (let i = 1; i < startDay; i++) {
        const div = document.createElement('div');
        calendarEl.appendChild(div);
      }

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const div = document.createElement('div');
        div.className = 'day';
        div.innerText = day;

        const hasEntry = serverData.some(e => e.date === dateStr);
        const isPast = new Date(dateStr) < new Date(new Date().setHours(0,0,0,0));

        if (hasEntry) {
          div.style.backgroundColor = isPast ? '#d4edda' : '#f8d7da';
          div.style.color = '#333';
        }

        div.onclick = () => {
          selectedDate = dateStr;
          selectedDateEl.value = dateStr;
          toggleAddForm(true);
        };

        calendarEl.appendChild(div);
      }
    }

    function saveEntry() {
      if (!selectedDate) return alert('Выберите дату');
      const time = document.getElementById('time').value;
      const service = document.getElementById('service').value;
      const income = parseFloat(document.getElementById('income').value) || 0;
      const expenses = parseFloat(document.getElementById('expenses').value) || 0;

      if (!time) return alert('Введите время');

      // Отправляем данные боту
      const entry = {
        action: "new_entry",
        user_id: userId,
        date: selectedDate,
        time,
        service,
        income,
        expenses
      };

      tg.sendData(JSON.stringify(entry));

      // Локальное обновление
      serverData.push(entry);
      renderEntries();
      loadCalendar(currentMonthOffset);
      toggleAddForm(false);

      // Уведомление о сохранении
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'fixed';
      tempDiv.style.bottom = '20px';
      tempDiv.style.left = '50%';
      tempDiv.style.transform = 'translateX(-50%)';
      tempDiv.style.backgroundColor = '#28a745';
      tempDiv.style.color = 'white';
      tempDiv.style.padding = '12px 24px';
      tempDiv.style.borderRadius = '8px';
      tempDiv.style.zIndex = '1000';
      tempDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      tempDiv.innerText = '✅ Запись сохранена!';
      document.body.appendChild(tempDiv);

      setTimeout(() => {
        document.body.removeChild(tempDiv);
        location.href = 'tg://close';
      }, 1500);
    }

    function toggleAddForm(show) {
      if (show) {
        document.getElementById('selectedDate').value = selectedDate;
        addForm.style.display = 'block';
      } else {
        addForm.style.display = 'none';
      }
    }

    // Приём данных от бота
    window.addEventListener("message", function(event) {
      try {
        const data = JSON.parse(event.data);
        if (data.action === "sync") {
          serverData = data.entries || [];
        }
      } catch (e) {
        console.error("Ошибка парсинга данных:", e);
      }
    });

    // Загрузка начальной страницы
    window.addEventListener("load", () => {
      fetchServerData(() => {
        showYears();
      });
    });
  </script>
</body>
</html>

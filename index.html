<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ª—É–≥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script> 
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f2f2f7;
      color: #333;
    }
    header {
      background: #007aff;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      padding: 16px;
    }
    .calendar {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }
    .day, .month {
      background: white;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    .form-group {
      margin-bottom: 12px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 4px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #007aff;
      color: white;
      border: none;
      font-weight: bold;
    }
    .stats {
      margin-top: 20px;
      background: white;
      padding: 16px;
      border-radius: 8px;
    }
    .entry-list {
      margin-top: 20px;
    }
    .entry {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* –ú–µ—Å—è—Ü–∞ */
    .month {
      width: calc(33.33%); /* 3 –∫–æ–ª–æ–Ω–∫–∏ */
      margin-bottom: 16px;
    }
    .calendar {
      grid-template-columns: repeat(3, 1fr); /* 3 –∫–æ–ª–æ–Ω–∫–∏ */
    }

    /* –ú–µ—Å—è—Ü —Å –∑–∞–ø–∏—Å—è–º–∏ */
    .month.has-entries {
      background-color: #d4edda !important;
      color: #155724;
    }

    /* –î–µ–Ω—å —Å –∑–∞–ø–∏—Å—è–º–∏ */
    .day.has-entries {
      background-color: #d4edda !important;
      color: #155724;
    }

    /* –ú–µ–Ω—å—à–µ —Å—Ç—Ä–µ–ª–æ–∫ */
    #backBtn, #nextBtn {
      font-size: 16px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <header>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å–ª—É–≥</header>
  <main>
    <div id="closeButtonContainer" style="display:none;">
    <button id="closeButton">‚ùå –ó–∞–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
  </div>
  <!-- ... -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ Web App –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
    const isMobile = /iPhone|iPad|iPod|Android/.test(navigator.userAgent);

    function saveEntry() {
      if (!selectedDate) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
      const time = document.getElementById('time').value;
      const service = document.getElementById('service').value;
      const income = parseFloat(document.getElementById('income').value) || 0;
      const expenses = parseFloat(document.getElementById('expenses').value) || 0;

      if (!time) return alert('–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è');

      const key = `calendarEntries_${userId}`;
      const entries = JSON.parse(localStorage.getItem(key) || "[]");
      entries.push({ date: selectedDate, time, service, income, expenses });
      localStorage.setItem(key, JSON.stringify(entries));

      tg.sendData(JSON.stringify({
        action: "new_entry",
        user_id: userId,
        date: selectedDate,
        time,
        service,
        income,
        expenses
      }));

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'fixed';
      tempDiv.style.bottom = '20px';
      tempDiv.style.left = '50%';
      tempDiv.style.transform = 'translateX(-50%)';
      tempDiv.style.backgroundColor = '#28a745';
      tempDiv.style.color = 'white';
      tempDiv.style.padding = '12px 24px';
      tempDiv.style.borderRadius = '8px';
      tempDiv.style.zIndex = '1000';
      tempDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      tempDiv.innerText = '‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!';
      document.body.appendChild(tempDiv);

      setTimeout(() => {
        document.body.removeChild(tempDiv);
        if (!isMobile) {
          tg.WebApp.close();  // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
        } else {
          // –î–ª—è iPhone –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å"
          document.getElementById('closeButtonContainer').style.display = 'block';
        }
      }, 1500);
    }

    // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å" –¥–ª—è iPhone
    document.getElementById('closeButton').onclick = () => {
      location.href = 'tg://close';  // –ó–∞–∫—Ä—ã–≤–∞–µ—Ç Web App –Ω–∞ iPhone
    };
  </script>
    <button onclick="clearLocalStorage()">üóë –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button> 
    <div style="display:flex;justify-content:space-between;margin-bottom:16px;">
      <button id="backBtn">‚¨ÖÔ∏è</button>
      <div id="monthTitle" style="font-size: 18px; font-weight: bold;"></div>
      <button id="nextBtn">‚û°Ô∏è</button>
    </div>

    <div class="calendar" id="calendar"></div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div id="addForm" style="display:none;">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
      <div class="form-group">
        <label>–î–∞—Ç–∞</label>
        <input type="text" id="selectedDate" readonly />
      </div>
      <div class="form-group">
        <label>–í—Ä–µ–º—è</label>
        <input type="time" id="time" />
      </div>
      <div class="form-group">
        <label>–£—Å–ª—É–≥–∞</label>
        <select id="service">
          <option value="–ú–∞–∫–∏—è–∂">–ú–∞–∫–∏—è–∂</option>
          <option value="–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å</option>
          <option value="–ü–æ–ª–Ω—ã–π –æ–±—Ä–∞–∑">–ü–æ–ª–Ω—ã–π –æ–±—Ä–∞–∑</option>
        </select>
      </div>
      <div class="form-group">
        <label>–î–æ—Ö–æ–¥ (‚ÇΩ)</label>
        <input type="number" id="income" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3000" />
      </div>
      <div class="form-group">
        <label>–†–∞—Å—Ö–æ–¥—ã (–º–∞—Ç–µ—Ä–∏–∞–ª—ã, ‚ÇΩ)</label>
        <input type="number" id="expenses" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" />
      </div>
      <button onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="stats" id="stats"></div>
    <div class="entry-list" id="entryList"></div>
  </main>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const calendarEl = document.getElementById('calendar');
    const selectedDateEl = document.getElementById('selectedDate');
    const entryListEl = document.getElementById('entryList');
    const statsEl = document.getElementById('stats');
    const monthTitle = document.getElementById('monthTitle');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const addForm = document.getElementById('addForm');

    let currentView = 'year'; // year | months-grid | day
    let currentYear = new Date().getFullYear();
    let currentMonthOffset = 0; // offset from current month
    let selectedMonth = new Date().getMonth(); // 0-11
    let selectedDate = '';
    const user = tg.initDataUnsafe?.user;
    const userId = user ? user.id : 'unknown';

    function updateNavVisibility() {
      backBtn.style.display = currentView === 'day' ? 'inline-block' : 'none';
      nextBtn.style.display = currentView === 'day' ? 'inline-block' : 'none';
    }

    function showYears() {
      currentView = 'year';
      updateNavVisibility();
      monthTitle.textContent = currentYear;

      calendarEl.innerHTML = '';

      for (let i = currentYear - 10; i <= currentYear + 10; i++) {
        const div = document.createElement('div');
        div.className = 'day';
        div.innerText = i;
        div.onclick = () => {
          currentYear = i;
          showMonthsGrid(i);
        };
        calendarEl.appendChild(div);
      }

      renderStatsForYear(currentYear);
    }
    
function clearLocalStorage() {
  if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏?")) {
    localStorage.removeItem(`calendarEntries_${userId}`);
    alert("–õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã!");
    location.reload();
  }
}
    function showMonthsGrid(year) {
      currentView = 'months-grid';
      updateNavVisibility();
      monthTitle.textContent = year;

      calendarEl.innerHTML = '';

      const monthNames = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω—å",
                          "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];

      const entries = JSON.parse(localStorage.getItem(`calendarEntries_${userId}`) || "[]");

      const incomeByMonth = {};
      entries.forEach(e => {
        const [y, m] = e.date.split('-');
        if (!incomeByMonth[y]) incomeByMonth[y] = {};
        incomeByMonth[y][m] = true;
      });

      for (let i = 0; i < 12; i++) {
        const dateStr = `${year}-${String(i + 1).padStart(2, '0')}`;
        const hasEntry = incomeByMonth[year]?.[String(i + 1).padStart(2, '0')];

        const div = document.createElement('div');
        div.className = 'month';
        if (hasEntry) div.classList.add('has-entries');
        div.innerText = monthNames[i];
        div.onclick = () => {
          selectedMonth = i;
          currentMonthOffset = (year - new Date().getFullYear()) * 12 + i - new Date().getMonth();
          loadCalendar(currentMonthOffset);
        };
        calendarEl.appendChild(div);
      }

      renderStatsForYear(year);
    }

    function loadCalendar(monthOffset = 0) {
      currentView = 'day';
      updateNavVisibility();

      const now = new Date();
      now.setMonth(now.getMonth() + monthOffset);
      const year = now.getFullYear();
      const month = now.getMonth();
      const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å",
                          "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
      monthTitle.textContent = `${monthNames[month]} ${year}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay() || 7;

      const entries = JSON.parse(localStorage.getItem(`calendarEntries_${userId}`) || "[]");

      const monthEntries = entries.filter(e => e.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`));
      const totalIncome = monthEntries.reduce((sum, e) => sum + (e.income - e.expenses), 0);

      statsEl.innerHTML = `
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <p>–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü: ${totalIncome.toFixed(2)} ‚ÇΩ</p>
      `;

      calendarEl.innerHTML = '';

      // Empty cells
      for (let i = 1; i < startDay; i++) {
        const div = document.createElement('div');
        calendarEl.appendChild(div);
      }

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const div = document.createElement('div');
        div.className = 'day';
        if (dateStr === selectedDate) div.classList.add('active');

        const hasEntry = entries.some(e => e.date === dateStr);
        const isPast = new Date(dateStr) < new Date(new Date().setHours(0,0,0,0));

        if (hasEntry) {
          div.style.backgroundColor = isPast ? '#d4edda' : '#f8d7da';
          div.style.color = '#333';
        }

        div.innerText = day;
        div.onclick = () => {
          selectedDate = dateStr;
          selectedDateEl.value = dateStr;
          renderEntries();
          toggleAddForm(true);
        };
        calendarEl.appendChild(div);
      }

      toggleAddForm(false);
    }

    function saveEntry() {
  if (!selectedDate) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
  const time = document.getElementById('time').value;
  const service = document.getElementById('service').value;
  const income = parseFloat(document.getElementById('income').value) || 0;
  const expenses = parseFloat(document.getElementById('expenses').value) || 0;

  if (!time) return alert('–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è');

  const key = `calendarEntries_${userId}`;
  const entries = JSON.parse(localStorage.getItem(key) || "[]");
  entries.push({ date: selectedDate, time, service, income, expenses });
  localStorage.setItem(key, JSON.stringify(entries));

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
  tg.sendData(JSON.stringify({
    action: "new_entry",
    user_id: userId,
    date: selectedDate,
    time,
    service,
    income,
    expenses
  }));

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º Web App
  const tempDiv = document.createElement('div');
  tempDiv.style.position = 'fixed';
  tempDiv.style.bottom = '20px';
  tempDiv.style.left = '50%';
  tempDiv.style.transform = 'translateX(-50%)';
  tempDiv.style.backgroundColor = '#28a745';
  tempDiv.style.color = 'white';
  tempDiv.style.padding = '12px 24px';
  tempDiv.style.borderRadius = '8px';
  tempDiv.style.zIndex = '1000';
  tempDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
  tempDiv.innerText = '‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!';
  document.body.appendChild(tempDiv);

  setTimeout(() => {
    document.body.removeChild(tempDiv);
    tg.WebApp.close();  // –ó–∞–∫—Ä—ã—Ç–∏–µ Web App
  }, 1500);
}

    function renderEntries() {
      const key = `calendarEntries_${userId}`;
      const entries = JSON.parse(localStorage.getItem(key) || "[]").filter(e => e.date === selectedDate);
      entryListEl.innerHTML = '';
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <strong>${entry.time}</strong><br>
          ${entry.service}<br>
          –î–æ—Ö–æ–¥: ${entry.income} ‚ÇΩ<br>
          –†–∞—Å—Ö–æ–¥—ã: ${entry.expenses} ‚ÇΩ
        `;
        entryListEl.appendChild(div);
      });
    }

    function renderStats() {
      const key = `calendarEntries_${userId}`;
      const entries = JSON.parse(localStorage.getItem(key) || "[]");

      const today = new Date().toISOString().split('T')[0];
      const thisMonth = today.slice(0, 7);

      const totalToday = entries.filter(e => e.date === today)
        .reduce((sum, e) => sum + (e.income - e.expenses), 0);

      const totalMonth = entries.filter(e => e.date.startsWith(thisMonth))
        .reduce((sum, e) => sum + (e.income - e.expenses), 0);

      const totalAll = entries.reduce((sum, e) => sum + (e.income - e.expenses), 0);

      statsEl.innerHTML = `
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <p>–°–µ–≥–æ–¥–Ω—è: ${totalToday.toFixed(2)} ‚ÇΩ</p>
        <p>–≠—Ç–æ—Ç –º–µ—Å—è—Ü: ${totalMonth.toFixed(2)} ‚ÇΩ</p>
        <p>–û–±—â–∏–π –¥–æ—Ö–æ–¥: ${totalAll.toFixed(2)} ‚ÇΩ</p>
      `;
    }

    function renderStatsForYear(year) {
      const key = `calendarEntries_${userId}`;
      const entries = JSON.parse(localStorage.getItem(key) || "[]");

      const yearEntries = entries.filter(e => e.date.startsWith(year));
      const totalIncome = yearEntries.reduce((sum, e) => sum + (e.income - e.expenses), 0);

      statsEl.innerHTML = `
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ ${year}</h4>
        <p>–î–æ—Ö–æ–¥ –∑–∞ –≥–æ–¥: ${totalIncome.toFixed(2)} ‚ÇΩ</p>
      `;
    }

    function toggleAddForm(show) {
      addForm.style.display = show ? 'block' : 'none';
    }

    backBtn.onclick = () => {
      if (currentView === 'year') {
        currentYear--;
        showYears();
      } else if (currentView === 'months-grid') {
        currentYear--;
        showMonthsGrid(currentYear);
      } else if (currentView === 'day') {
        currentMonthOffset--;
        loadCalendar(currentMonthOffset);
      }
    };

    nextBtn.onclick = () => {
      if (currentView === 'year') {
        currentYear++;
        showYears();
      } else if (currentView === 'months-grid') {
        currentYear++;
        showMonthsGrid(currentYear);
      } else if (currentView === 'day') {
        currentMonthOffset++;
        loadCalendar(currentMonthOffset);
      }
    };

    function syncData() {
      const tg = window.Telegram.WebApp;
      const user = tg.initDataUnsafe?.user;

      if (!user) return;

      tg.sendData(JSON.stringify({
        action: "sync",
        user_id: user.id
      }));
    }

    window.addEventListener("load", () => {
      showYears();
      renderStats();
      syncData();
    });
  </script>
</body>
</html>
